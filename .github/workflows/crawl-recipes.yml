name: Crawl Recipes

on:
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: crawl-recipes-${{ github.ref }}
  cancel-in-progress: false

jobs:
  crawl:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      NODE_ENV: production
      NODE_OPTIONS: --max-old-space-size=1536

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # npm ci ha fallito perché il lockfile non è allineato.
      # Installiamo le dipendenze richieste e generiamo un lock pulito.
      - name: Bootstrap deps
        run: |
          npm init -y >/dev/null 2>&1 || true
          npm pkg set scripts.crawl="node script/crawl_recipes.mjs"
          npm pkg set scripts.merge="node script/merge_recipes.mjs"

          # Dipendenze usate dagli script di crawl
          npm install \
            cheerio@^1 \
            cheerio-select@^2 \
            encoding-sniffer@^0.2 \
            htmlparser2@^9 \
            parse5@^7 \
            parse5-htmlparser2-tree-adapter@^7 \
            parse5-parser-stream@^7 \
            undici@^6 \
            iconv-lite@^0.6 \
            whatwg-mimetype@^4 \
            whatwg-encoding@^3 \
            entities@^4 \
            --no-audit --no-fund --save

      - name: Ensure data files exist
        run: |
          mkdir -p assets/json
          [ -f assets/json/urls_last.json ] || echo "[]" > assets/json/urls_last.json
          [ -f assets/json/recipes-index.jsonl ] || echo "" > assets/json/recipes-index.jsonl
          [ -f assets/json/recipes-it.json ] || echo '{"recipes":[]}' > assets/json/recipes-it.json

      - name: Run npm run crawl
        run: |
          npm run crawl || true
          node script/crawl_recipes.mjs || true

      - name: Run npm run merge
        run: |
          npm run merge || true
          node script/merge_recipes.mjs || true

      - name: Show index preview
        run: |
          echo "== assets/json =="
          ls -al assets/json || true

      - name: Detect changes
        id: diff
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit changes
        if: steps.diff.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -m "chore: crawl and merge recipes"
          git push
