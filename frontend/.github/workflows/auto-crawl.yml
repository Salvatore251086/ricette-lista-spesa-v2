name: Auto Crawl Sitemap

on:
  schedule:
    # Esegui ogni settimana la domenica alle 01:00 UTC
    - cron: '0 1 * * 0'
  workflow_dispatch:  # Permette esecuzione manuale

jobs:
  crawl-sitemap:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run crawl
        run: |
          echo "Crawling sitemaps..."
          node script/crawl_recipes.mjs
      
      - name: Check for new URLs
        id: check
        run: |
          # Conta nuovi URL trovati
          if [ -f assets/json/crawl_last.json ]; then
            NEW_URLS=$(cat assets/json/crawl_last.json | jq '.added // 0')
            TOTAL_URLS=$(cat assets/json/crawl_last.json | jq '.total_indexed // 0')
            echo "NEW_URLS=$NEW_URLS" >> $GITHUB_ENV
            echo "TOTAL_URLS=$TOTAL_URLS" >> $GITHUB_ENV
            echo "found_new=true" >> $GITHUB_OUTPUT
          else
            echo "found_new=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate report
        if: steps.check.outputs.found_new == 'true'
        run: |
          echo "## Crawl Report üîç" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Nuovi URL trovati**: ${{ env.NEW_URLS }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Totale URL indicizzati**: ${{ env.TOTAL_URLS }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Data**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
      
      - name: Commit and push changes
        if: steps.check.outputs.found_new == 'true' && env.NEW_URLS > 0
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add assets/json/recipes-index.jsonl
          git add assets/json/crawl_last.json
          
          git commit -m "üîç Auto-crawl: ${{ env.NEW_URLS }} nuovi URL [skip ci]" || exit 0
          git push
      
      - name: Upload crawl logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: crawl-logs
          path: |
            assets/json/crawl_last.json
          retention-days: 30
